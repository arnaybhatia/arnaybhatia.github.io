{% extends "base.html" %}

{% block title %}{{ player_name }}'s Portfolio{% endblock %}

{% block content %}
<!-- Player Info Header -->
<div class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white py-8 px-4 mb-8">
    <div class="container mx-auto">
        <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
                {% if player_name == 'teachermiller' %}
                <img src="/static/miller.jpg" alt="Mr. Miller" class="w-24 h-24 rounded-full object-cover border-4 border-white">
                {% else %}
                <div class="w-24 h-24 rounded-full bg-white/20 flex items-center justify-center text-3xl font-bold">
                    {{ player_name[0] | upper }}
                </div>
                {% endif %}
                <div>
                    <h1 class="text-4xl font-bold mb-2">{{ player_name }}</h1>
                    <a href="{{ investopedia_link }}" class="text-white/80 hover:text-white underline" target="_blank">View Investopedia Profile â†’</a>
                </div>
            </div>
            <div class="text-right">
                <p class="text-white/80">Last Updated</p>
                <p class="text-2xl">{{ update_time }}</p>
            </div>
        </div>
    </div>
</div>

<!-- Performance Metrics -->
<div class="container mx-auto mb-8 grid grid-cols-1 md:grid-cols-3 gap-4 px-4">
    <div class="bg-white rounded-lg shadow p-6 transform hover:scale-105 transition-transform">
        <h3 class="text-gray-500 mb-2">Current Portfolio Value</h3>
        <p class="text-3xl font-bold">${{ '{:,.2f}'.format(player_money[-1]) }}</p>
    </div>
    <div class="bg-white rounded-lg shadow p-6 transform hover:scale-105 transition-transform">
        <h3 class="text-gray-500 mb-2">Total Return</h3>
        {% set total_return = ((player_money[-1] - 100000) / 100000) * 100 %}
        <p class="text-3xl font-bold {% if total_return >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
            {{ '{:+.2f}%'.format(total_return) }}
        </p>
    </div>
    <div class="bg-white rounded-lg shadow p-6 transform hover:scale-105 transition-transform">
        <h3 class="text-gray-500 mb-2">Active Positions</h3>
        <p class="text-3xl font-bold">{{ player_stocks|length }}</p>
    </div>
</div>

<!-- Chart Section -->
<div class="container mx-auto px-4 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <div class="flex flex-col h-[600px]">
            <!-- Legend -->
            <div class="legend flex justify-center mb-4 space-x-6 p-2 bg-gray-50 rounded-lg">
                {% for series in [
                    ('portfolio', 'Portfolio', 'rgb(75, 192, 192)'),
                    ('sp500', 'S&P 500', 'rgb(192, 75, 75)'),
                    ('tqqq', 'TQQQ', 'rgb(75, 75, 192)'),
                    ('nvda', 'NVDA', 'rgb(0, 192, 0)'),
                    ('djt', 'DJT', 'rgb(192, 192, 0)')
                ] %}
                <div class="legend-item cursor-pointer {{ 'active' if loop.index <= 2 else '' }}" data-series="{{ series[0] }}">
                    <span class="legend-color" style="background: {{ series[2] }}"></span>
                    {{ series[1] }}
                </div>
                {% endfor %}
            </div>
            
            <!-- Chart Container -->
            <div class="flex-grow" id="chartContainer">
                <div id="playerChart"></div>
            </div>
            
            <!-- Time Range Controls -->
            <div class="flex justify-center mt-4 space-x-2">
                <button class="uk-button uk-button-default px-4 py-2" id="resetZoom">Reset</button>
                {% for period in [('1D', 1), ('1W', 7), ('1M', 30), ('1Y', 365)] %}
                <button class="uk-button uk-button-default px-4 py-2 time-range" data-days="{{ period[1] }}">{{ period[0] }}</button>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- Holdings Table -->
<div class="container mx-auto px-4 mb-8">
    <div class="bg-white rounded-lg shadow p-6">
        <h2 class="text-2xl font-bold mb-4">Current Holdings</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symbol</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Investment</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Return</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for stock in player_stocks %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap font-medium">{{ stock[0] }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">${{ '{:,.2f}'.format(stock[1]) }}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-right {% if stock[2] >= 0 %}text-green-600{% else %}text-red-600{% endif %}">
                            {{ '{:+.2f}%'.format(stock[2]) }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function convertTZ(date, tzString) {
        return new Date((typeof date === "string" ? new Date(date) : date).toLocaleString("en-US", {timeZone: tzString}));   
    }

    function isDarkMode() {
        return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    }

    function getChartColors() {
        return {
            background: isDarkMode() ? '#1a1a1a' : '#ffffff',
            text: isDarkMode() ? '#ffffff' : '#333333',
            grid: isDarkMode() ? '#333333' : '#f0f0f0',
            border: isDarkMode() ? '#4a4a4a' : '#d1d4dc'
        };
    }

    function updateChartColors() {
        const colors = getChartColors();
        chart.applyOptions({
            layout: {
                background: { type: 'solid', color: colors.background },
                textColor: colors.text,
            },
            grid: {
                vertLines: { color: colors.grid },
                horzLines: { color: colors.grid },
            },
            timeScale: {
                borderColor: colors.border,
            },
            rightPriceScale: {
                borderColor: colors.border,
            }
        });
    }

    const chartContainer = document.getElementById('chartContainer');
    const colors = getChartColors();
    const chartOptions = {
        width: chartContainer.offsetWidth,
        height: chartContainer.offsetHeight,
        layout: {
            background: { type: 'solid', color: colors.background },
            textColor: colors.text,
            fontSize: 12,
        },
        grid: {
            vertLines: { color: colors.grid },
            horzLines: { color: colors.grid },
        },
        timeScale: {
            timeVisible: true,
            borderColor: colors.border,
            rightOffset: 5,
            barSpacing: 10,
            fixLeftEdge: true,
            fixRightEdge: true,
            secondsVisible: false,
            timeZone: 'America/Los_Angeles',  // Add this line
        },
        rightPriceScale: {
            borderColor: colors.border,
            autoScale: true,
        },
        watermark: {
            color: 'rgba(0, 0, 0, 0)',
        },
        leftPriceScale: {
            visible: false,
        },
        handleScale: {
            mouseWheel: true,
            pinch: true,
            axisPressedMouseMove: true,
        },
        handleScroll: {
            mouseWheel: true,
            pressedMouseMove: true,
            horzTouchDrag: true,
            vertTouchDrag: true,
        },
    };

    // Add color scheme change listener
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateChartColors);

    const chart = LightweightCharts.createChart(document.getElementById('playerChart'), chartOptions);

    const portfolioSeries = chart.addAreaSeries({
        lineColor: 'rgb(75, 192, 192)',
        topColor: 'rgba(75, 192, 192, 0.4)',
        bottomColor: 'rgba(75, 192, 192, 0.1)',
        lineWidth: 2,
    });

    const sp500Series = chart.addAreaSeries({
        lineColor: 'rgb(192, 75, 75)',
        topColor: 'rgba(192, 75, 75, 0.4)',
        bottomColor: 'rgba(192, 75, 75, 0.1)',
        lineWidth: 2,
    });

    const tqqqSeries = chart.addAreaSeries({
        lineColor: 'rgb(75, 75, 192)',
        topColor: 'rgba(75, 75, 192, 0.4)',
        bottomColor: 'rgba(75, 75, 192, 0.1)',
        lineWidth: 2,
        visible: false,  // Add this line
    });

    const nvdaSeries = chart.addAreaSeries({
        lineColor: 'rgb(0, 192, 0)',
        topColor: 'rgba(0, 192, 0, 0.4)',
        bottomColor: 'rgba(0, 192, 0, 0.1)',
        lineWidth: 2,
        visible: false,  // Add this line
    });

    const djtSeries = chart.addAreaSeries({
        lineColor: 'rgb(192, 192, 0)',
        topColor: 'rgba(192, 192, 0, 0.4)',
        bottomColor: 'rgba(192, 192, 0, 0.1)',
        lineWidth: 2,
        visible: false,  // Add this line
    });

    const labels = {{ labels | safe }};
    const money = {{ player_money | safe }};
    const sp500Data = {{ sp500_prices | safe }};
    const tqqqData = {{ tqqq_prices | safe }};
    const nvdaData = {{ nvda_prices | safe }};
    const djtData = {{ djt_prices | safe }};

    const portfolioData = labels.map((timeStr, i) => {
        const date = new Date(timeStr);
        // Convert to PST
        const pstDate = convertTZ(date, 'America/Los_Angeles');
        return {
            time: Math.floor(date.getTime() / 1000),
            value: money[i] || 0
        };
    }).filter(item => item.value !== 0);

    const sp500ChartData = labels.map((timeStr, i) => {
        const date = new Date(timeStr);
        // Convert to PST
        const pstDate = convertTZ(date, 'America/Los_Angeles');
        return {
            time: Math.floor(date.getTime() / 1000),
            value: sp500Data[i] || 0
        };
    }).filter(item => item.value !== 0);

    const tqqqChartData = labels.map((timeStr, i) => {
        const date = new Date(timeStr);
        // Convert to PST
        const pstDate = convertTZ(date, 'America/Los_Angeles');
        return {
            time: Math.floor(date.getTime() / 1000),
            value: tqqqData[i] || 0
        };
    }).filter(item => item.value !== 0);

    const nvdaChartData = labels.map((timeStr, i) => {
        const date = new Date(timeStr);
        // Convert to PST
        const pstDate = convertTZ(date, 'America/Los_Angeles');
        return {
            time: Math.floor(date.getTime() / 1000),
            value: nvdaData[i] || 0
        };
    }).filter(item => item.value !== 0);

    const djtChartData = labels.map((timeStr, i) => {
        const date = new Date(timeStr);
        // Convert to PST
        const pstDate = convertTZ(date, 'America/Los_Angeles');
        return {
            time: Math.floor(date.getTime() / 1000),
            value: djtData[i] || 0
        };
    }).filter(item => item.value !== 0);

    // Sort data by timestamp
    portfolioData.sort((a, b) => a.time - b.time);
    sp500ChartData.sort((a, b) => a.time - b.time);
    tqqqChartData.sort((a, b) => a.time - b.time);
    nvdaChartData.sort((a, b) => a.time - b.time);
    djtChartData.sort((a, b) => a.time - b.time);

    portfolioSeries.setData(portfolioData);
    sp500Series.setData(sp500ChartData);
    tqqqSeries.setData(tqqqChartData);
    nvdaSeries.setData(nvdaChartData);
    djtSeries.setData(djtChartData);

    chart.timeScale().fitContent();

    window.addEventListener('resize', () => {
        chart.applyOptions({
            width: chartContainer.offsetWidth,
            height: chartContainer.offsetHeight
        });
    });

    // Add reset zoom button functionality
    document.getElementById('resetZoom').addEventListener('click', () => {
        chart.timeScale().fitContent();
        chart.priceScale('right').applyOptions({
            autoScale: true
        });
    });

    // Add time range functionality
    document.querySelectorAll('.time-range').forEach(button => {
        button.addEventListener('click', () => {
            const days = parseInt(button.dataset.days);
            const now = Math.floor(Date.now() / 1000);
            const start = now - (days * 24 * 60 * 60);
            
            chart.timeScale().setVisibleRange({
                from: start,
                to: now,
            });
        });
    });

    // Store series in an object for easy access
    const series = {
        portfolio: portfolioSeries,
        sp500: sp500Series,
        tqqq: tqqqSeries,
        nvda: nvdaSeries,
        djt: djtSeries
    };

    // Replace button toggle functionality with legend toggle
    document.querySelectorAll('.legend-item').forEach(item => {
        item.addEventListener('click', () => {
            const seriesName = item.dataset.series;
            item.classList.toggle('active');
            const isVisible = item.classList.contains('active');
            series[seriesName].applyOptions({
                visible: isVisible
            });
        });
    });

    // Initial fit content
    chart.timeScale().fitContent();
</script>
{% endblock %}

{% block styles %}
<style>
.legend-item {
    @apply flex items-center px-3 py-1 rounded-full text-sm font-medium transition-all;
    opacity: 0.5;
}

.legend-item.active {
    @apply bg-gray-200;
    opacity: 1;
}

.legend-color {
    @apply inline-block w-3 h-3 rounded-full mr-2;
}

@media (prefers-color-scheme: dark) {
    .legend-item {
        @apply text-white;
    }
    
    .legend-item.active {
        @apply bg-gray-700;
    }
}
</style>
{% endblock %}
